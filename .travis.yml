language: scala
dist: xenial
jdk: openjdk8
if: tag IS blank
branches:
  only:
  - master
env:
  global:
  - secure: nWvld27UvaC0pFB9VRFEw4Z1csGaaimX9Zqq4HJHAq6MNjfM7kd0fBLxoCPvsYpPMW3IFp2jKWq0AB3m0szsUDEF0auje+mzkvhspCfhJ9aM1Vch+x1MaQz2/oV6JkykCDZLUH3OgJ7vBwfI4ERaGeUKbtITpIqpm/l4/Xwk2UviemU5xXkeZQ9x0hwa9+Q8HQQoULAI5pqeKJk38viIj0b/j/YMGtcwyKNuVonGI1oYM0cGSN/Myo1XcCyVEA0sZOeh63KMriMe8Ddwyiue9iA2MMXN4y5TO8kQRgNkd5RWv5ihhw+Yj6g1FUM+xWTDcjyDoRL9mYV2rBuzWmykeypi4DyGl8lDUzMLEt9U//OquNlPp+zf9VQMRdS7j7BZ9BqDqlwpQwj+BGWGOFAPvbKl3KIrlyufC+nB7WGUAIor1Y5raLxhj80VXKueotDBHtkMvu18w+4xag5MI7GNIeVmdb+1IrnWy4LQGpVaqJTr8eqF/N0XPEUMeVtkjPLxcBTS23K8RApYNmCWKJo/0GrVR0+037/3uWc1fuYWQdYLQglyWYxdLi0TLBLoHakmvRJI2ANE5VruD5031M+kp08axbq2Pf3ZnTolSJwu6xMiVD6oOT+5N/xPE1OwTsN4MkQfBbzenYp+om5HGDSAhp+w4Be/dJFh1mvOOnsIwz8=
  - secure: cPD0ZOro6qjMpoTtOP3avXkPdtBFjv+kcrXv2cnCTUZPPJwF5xCvXsocg6AqOMAFY4K6PGqgMDfY3VbeQ7aPt21bc8Rbd2qVqMNgETtIqekMZxwPzv/lA45Dc/h/4h57eAE7VFKCag/u1nC/c2qKgjGVKM7LHpp6SL/emrMU3kajdneQa5W+BnLWWC9v5E49H1wnTr/DL+ouJLxrr12q1qbQAgw0mB3fXZWga1IpJfxrJ9ktzPEUlcu+1gPGwLZbu8RBB0JrTxj0fVP9Hc1RWlQmniMjn78MoDa6x/7t8Y56S27YVkeu40l7ZE/9V5+uwSooabxqdWQTWpqnUwv6FXJXT1CF31+jxLR5cmHStbMm1UfhYorG1ykGhX/9B6kONMlFWBBovTQpR+aHA97PYBVNP3/YOJwViVaaSorLZutZ9fswAgpzeW3wWgRXlqQ2O2itJySiKvKca6UqfVCOoAV4TqOaAWqGLSutZEqtfF8CaD9cjNchrucgtUTic4+CQL07LyXb3EYb1swTKKuHwcLvAxzHCGfSLg9ZwPP/mX8zNTP0ynQNlmMbg95T3gDbEitlnPsJIXH7UVmrOMhmaxxWEY4QKrYfNAzn2dRGo4Dp+/vhMVOvlJZXvNjZmo8XRm6CKevtfwCpZM9o7tpzamNRmPdHwLHKUPk1NenE8j4=
before_install:
- git fetch --tags
- if [[ "$TRAVIS_BRANCH" == "master" && "$TRAVIS_EVENT_TYPE" == "push" ]]; then openssl
  aes-256-cbc -K $encrypted_b3f7bd94ef38_key -iv $encrypted_b3f7bd94ef38_iv -in private-key.pem.enc
  -out private-key.pem -d; gpg --import --batch private-key.pem; fi
stages:
- name: test
- name: tag-release
  if: branch = master AND type = push
- name: release
  if: branch = master AND type = push
jobs:
  include:
  - stage: test
    name: Build and test FuzzyC2CPG JAR & preprocessor
    addons:
      apt:
        sources:
        - sourceline: ppa:ubuntu-toolchain-r/test
        packages:
        - cmake
        - g++-8
    script:
    - sbt scalafmtCheck +test
    - cmake -DCMAKE_CXX_COMPILER=/usr/bin/g++-8 ./fuzzypp
    - cmake --build . -- -j4
    - "./fuzzypp/bin/fuzzyppcli-tests"
    before_cache:
    - find $HOME/.sbt -name "*.lock" -type f -delete
    - find $HOME/.ivy2/cache -name "ivydata-*.properties" -type f -delete
    - rm -rf $HOME/.ivy2/local
  - stage: test
    name: Build and test Windows preprocessor
    os: windows
    env: YARN_GPG=no
    language: cpp
    script:
    - cmake -G "Visual Studio 15 2017" -A "x64" ./fuzzypp
    - cmake --build . --config Release
    - "./fuzzypp/bin/Release/fuzzyppcli-tests.exe"
    after_script:
    - ps -ef
    - ps -Wla | sort
    - gpgconf --kill gpg-agent
    - ps -Wla | sort
    - echo $$
  - stage: tag-release
    name: Tag release
    script: sbt ciReleaseTagNextVersion
  - stage: release
    name: Release to shiftleft artifactory
    script: sbt 'set publishTo := Some("releases" at "https://shiftleft.jfrog.io/shiftleft/libs-release-local")'
      "set credentials += Credentials(\"Artifactory Realm\", \"shiftleft.jfrog.io\",
      \"$JFROG_USER\", \"$JFROG_PASS\")" ciRelease
  - stage: release
    name: Release to sonatype
    script: sbt ciReleaseSonatype
  - stage: release
    name: Release Unix preprocessor
    script: skip
    before_deploy: zip -j ./fuzzyppcli.zip ./fuzzypp/bin/fuzzyppcli
    deploy:
      edge: true
      provider: releases
      cleanup: false
      token: "$GITHUB_TOKEN"
      target_commitish: "$TRAVIS_COMMIT"
      file:
      - "./fuzzyppcli.zip"
  - stage: release
    name: Release Windows preprocessor
    os: windows
    env: YARN_GPG=no
    language: cpp
    script: skip
    before_deploy:
    - export TRAVIS_TAG=$(git describe --tags --abbrev=0)
    - 7z a -r -tzip ./fuzzyppcli-win.zip ./fuzzypp/bin/Release/fuzzyppcli.exe
    deploy:
      edge: true
      provider: releases
      cleanup: false
      token: "$GITHUB_TOKEN"
      tag_name: "$TRAVIS_TAG"
      target_commitish: "$TRAVIS_COMMIT"
      file:
      - "./fuzzyppcli-win.zip"
    after_deploy: gpgconf --kill gpg-agent
cache:
  directories:
  - "$HOME/.sbt/1.0/dependency"
  - "$HOME/.sbt/boot/scala*"
  - "$HOME/.sbt/launchers"
  - "$HOME/.ivy2/cache"
  - "$HOME/.coursier"
  - "./target"
  - "./fuzzypp/bin"
notifications:
  slack:
    secure: FeJ+o4Qe1sOx0goJuOslHMu9C/b9nmsTj4CO+U7sQIQi3eVXgDY5lN+CcK/tvt+9Xpm2TNvO8QP6KuJlogBAn10C3Wq/t3keeFvggD5BjoUhuAsxMjuGEgfFKiFQ8FM4SAmboIvRx8boIvBT6/uzigu8IlitKv0StjDfGEhcY0OyAcAV7/NQMKa9J9VcHhNNxMk3IOUYAnUBHi+k0YULCFF/OUkvJjGp+vIIDcELyn/3facQvY7vQcqgqZ9SVlGpkh2UtPS/dZTvk7o9ASi308cAjEwllRDqMghConVw4FBHv8F+ECi+lnEjm3NBB2W6wyoE+oucaIs3DCrKU7G6czCT0Jyc2mLf1v7zZbSngszeNkdpNg2OemkS+VbIsJoRUNM/Dbwva/Jxq4d90pEXlwEBEsmGAO7om/YH3uBx/PtTwYmMpDNg3SV2jH9X8T8jIMwT5Eh8k+i5s9sseJAl4tYrrqkYycJ6JpDfoDmknIoVy9QCmxvx49BgmEP1o7AhM2XvBNwUmAwCsgxmpS5UvD0HwJ++agbsW9B+yK+LNBOvcnl8l3Bh5uNH8iOzZjVZkX5996hkyuRPXW3MIDla39xQJyEOtslAw/T8Gy6Osa32xoiDgGC/ZcqQyWukV7og7sUDu80cKsmbOi9Hs+NlzmmgXSITqRvCxUYJDMSGKa0=
    on_success: change
    on_failure: always
