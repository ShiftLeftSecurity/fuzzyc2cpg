language: scala
dist: xenial
jdk: openjdk8
if: tag IS blank
branches:
  only:
  - master
env:
  global:
  - secure: FsZhMotDkax3SKDhqoMQT4iN/SKJYaC8i2+HPZldWwKOwmZ2M9giPoeelUC2pCsdGyJUy21WREzYQqqjQFM9K8MY9ewOvDLrX9MJ65e4tRPNm7IpmctCkST5s0cMS8je+FRz0xYaXc8QVkYl3mxX8+ZTb2KIhCTRNmD25C2tTTld2dhAgwr39UQn1FCPVr8FEpBk7ZdQxUaKICMAFwIR8MP7/+p+S/VhAI8cA3CZKhxBYgxbYD4N8221gqvbh/PLpwDGODGQYkqdtViOe18WH6IcxytsVz68zy4+UvuYdoYpISRQVBnWezAUSYpYjr3UTY5PwpWJQElWIzt6szvacg+KUs2+ZnW+BJYv6NwLJZnO5/oSHTyEnP+8HcmIyPFW5opFnpREcZx3pqfKYhLyv1rRY3jEvfAX5wqueY0yBcZBOhZoUU0PuWkTSZ5HKJMzjxD8BXiisqF+IZSaS+TRwuF4nuBTOBh1JXRbnS7vfsB8GFN/ROgmsXBzj3iM4PGZpMf6M4NKuVBHPBtGrUkg9eNkaw0WzQKDMwcOuagfa8opvkcvpLATD4dYClW1vjZ4yUjVGaxt/OZvoq8UEvdrGgEZgtVOohfB/9cjU7ChpsGQ0mE3AdWY8VXIFkh43a9jiYlwWvrDBsd17P6TygZlybRfxHVpDgH4KUWqy5w2LYo=
  - secure: LQBAfci8rjfwf6hWctFeutPj3k9voYbU4C9RBOo3jOketKYYyhDtWKZ/elA+RwvLztsnUTJRW5GHZMWTdyPvQxB2/WbtCy/L5f23o4P0Gd5MHJgGAPQpVV+C1g7iaMLn+rjsOyNnNcNesVOOQsVaDW/MQ4Jvl/9NyH0VuNTjtIH1x1XzmYEgD6/S6yxz01stAJslcPL6Qt9GnRyL6/sR0PGOI0w51ETwtcy+nO/ZTlvSCd3wBbH1iQ0A/X2YSDxYPtq1I6D5eRsmVs2Yzp0cAau1pFSBePqgKDkGqiDmbc/8y0KkJUGzQWi/AL8ts4gVz5gJhzH8ovoswgEX8CgqfQj5bBQdCR4QzwDjWKeumdaO8WP65SAnVVMTjgykzdrsFZrXi9ZoSV5Eve6gKOmumkGRXxqETYqWcchhXaiNaMUw40ZGzjIRVBDCWroHxy4crzm0jqfmmvh4bxW8bpO9Br8ZN5duI5HMojvL8WKt8tBAMkd5HJKBQqRbKdJwl1hd8LpJAXVg8EYVgnz3ui+IeyGnazg5k33qulVtkfjmaAexzM6KBcQz8hHr9pfyK23VzEGRSY24oNkatBEOLRH1X+AcNlGrzdXIQGA/+e4Rs3+Y6N8n7chn4Pti2rqwmDrmzjo+6FYbM1kKIZtwm4x1wto3Ofb4HQoHJFJ5k6f/WRY=
before_install:
- git fetch --tags
- if [[ "$TRAVIS_BRANCH" == "master" && "$TRAVIS_EVENT_TYPE" == "push" ]]; then openssl
  aes-256-cbc -K $encrypted_b3f7bd94ef38_key -iv $encrypted_b3f7bd94ef38_iv -in private-key.pem.enc
  -out private-key.pem -d; gpg --import --batch private-key.pem; fi
stages:
- name: test
- name: tag-release
  if: branch = master AND type = push
- name: release
  if: branch = master AND type = push
jobs:
  include:
  - stage: test
    name: Build and test FuzzyC2CPG JAR & preprocessor
    addons:
      apt:
        sources:
        - sourceline: ppa:ubuntu-toolchain-r/test
        packages:
        - cmake
        - g++-8
    script:
    - sbt scalafmtCheck +test
    - cmake -DCMAKE_CXX_COMPILER=/usr/bin/g++-8 ./fuzzypp
    - cmake --build . -- -j4
    - "./fuzzypp/bin/fuzzyppcli-tests"
    before_cache:
    - find $HOME/.sbt -name "*.lock" -type f -delete
    - find $HOME/.ivy2/cache -name "ivydata-*.properties" -type f -delete
    - rm -rf $HOME/.ivy2/local
  - stage: test
    name: Build and test Windows preprocessor
    os: windows
    env: YARN_GPG=no
    language: cpp
    script:
    - cmake -G "Visual Studio 15 2017" -A "x64" ./fuzzypp
    - cmake --build . --config Release
    - "./fuzzypp/bin/Release/fuzzyppcli-tests.exe"
    after_script:
    - ps -ef
    - ps -Wla | sort
    - gpgconf --kill gpg-agent
    - ps -Wla | sort
    - echo $$
  - stage: tag-release
    name: Tag release
    script: sbt ciReleaseTagNextVersion
  - stage: release
    name: Release to shiftleft artifactory
    script: sbt 'set publishTo := Some("releases" at "https://shiftleft.jfrog.io/shiftleft/libs-release-local")'
      "set credentials += Credentials(\"Artifactory Realm\", \"shiftleft.jfrog.io\",
      \"$JFROG_USER\", \"$JFROG_PASS\")" ciRelease
  - stage: release
    name: Release to sonatype
    script: sbt ciReleaseSonatype
  - stage: release
    name: Release Unix preprocessor
    script: skip
    before_deploy: zip -j ./fuzzyppcli.zip ./fuzzypp/bin/fuzzyppcli
    deploy:
      edge: true
      provider: releases
      cleanup: false
      token: "$GITHUB_TOKEN"
      target_commitish: "$TRAVIS_COMMIT"
      file:
      - "./fuzzyppcli.zip"
  - stage: release
    name: Release Windows preprocessor
    os: windows
    env: YARN_GPG=no
    language: cpp
    script: skip
    before_deploy:
    - export TRAVIS_TAG=$(git describe --tags --abbrev=0)
    - 7z a -r -tzip ./fuzzyppcli-win.zip ./fuzzypp/bin/Release/fuzzyppcli.exe
    deploy:
      edge: true
      provider: releases
      cleanup: false
      token: "$GITHUB_TOKEN"
      tag_name: "$TRAVIS_TAG"
      target_commitish: "$TRAVIS_COMMIT"
      file:
      - "./fuzzyppcli-win.zip"
    after_deploy: gpgconf --kill gpg-agent
cache:
  directories:
  - "$HOME/.sbt/1.0/dependency"
  - "$HOME/.sbt/boot/scala*"
  - "$HOME/.sbt/launchers"
  - "$HOME/.ivy2/cache"
  - "$HOME/.coursier"
  - "./target"
  - "./fuzzypp/bin"
notifications:
  slack:
    secure: FeJ+o4Qe1sOx0goJuOslHMu9C/b9nmsTj4CO+U7sQIQi3eVXgDY5lN+CcK/tvt+9Xpm2TNvO8QP6KuJlogBAn10C3Wq/t3keeFvggD5BjoUhuAsxMjuGEgfFKiFQ8FM4SAmboIvRx8boIvBT6/uzigu8IlitKv0StjDfGEhcY0OyAcAV7/NQMKa9J9VcHhNNxMk3IOUYAnUBHi+k0YULCFF/OUkvJjGp+vIIDcELyn/3facQvY7vQcqgqZ9SVlGpkh2UtPS/dZTvk7o9ASi308cAjEwllRDqMghConVw4FBHv8F+ECi+lnEjm3NBB2W6wyoE+oucaIs3DCrKU7G6czCT0Jyc2mLf1v7zZbSngszeNkdpNg2OemkS+VbIsJoRUNM/Dbwva/Jxq4d90pEXlwEBEsmGAO7om/YH3uBx/PtTwYmMpDNg3SV2jH9X8T8jIMwT5Eh8k+i5s9sseJAl4tYrrqkYycJ6JpDfoDmknIoVy9QCmxvx49BgmEP1o7AhM2XvBNwUmAwCsgxmpS5UvD0HwJ++agbsW9B+yK+LNBOvcnl8l3Bh5uNH8iOzZjVZkX5996hkyuRPXW3MIDla39xQJyEOtslAw/T8Gy6Osa32xoiDgGC/ZcqQyWukV7og7sUDu80cKsmbOi9Hs+NlzmmgXSITqRvCxUYJDMSGKa0=
    on_success: change
    on_failure: always
